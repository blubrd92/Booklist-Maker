<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Booklist Maker</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Garamond:wght@400;700&family=Lato:wght@400;700&family=Merriweather:wght@400;700&family=Roboto:wght@400;700&family=Oswald:wght@700&family=Anton&display=swap');

        body { font-family: sans-serif; background-color: #f0f2f5; }
        h1, h2 { text-align: center; }
        .search-form { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-bottom: 15px; padding: 0 20px; }
        .form-field { display: flex; flex-direction: column; }
        .form-field label { margin-bottom: 5px; font-weight: bold; }
        .form-field input, .form-field select { padding: 8px; width: 100%; box-sizing: border-box; }
        #fetchButton { padding: 10px 15px; font-size: 1em; cursor: pointer; display: block; margin: 0 auto; }
        hr { margin: 20px 0; }

        #results-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 20px; margin-top: 20px; padding: 0 20px; }
        #results-container div { text-align: center; display: flex; flex-direction: column; justify-content: space-between; background: white; padding: 10px; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        #results-container button {
            margin-top: 10px;
            padding: 8px;
            cursor: pointer;
            height: 38px;
            min-width: 90px;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #results-container img { width: 100%; height: auto; border: 1px solid #ccc; }
        #results-container button.added {
            background-color: #28a745;
            color: white;
            border-color: #218838;
            font-size: 1.2em;
        }

        .booklist-section { margin-top: 40px; padding: 20px; background-color: #e2e8f0; }
        .export-controls { 
            background-color: white; 
            border-radius: 5px; 
            padding: 15px; 
            margin: 0 auto 20px auto; /* Center the container and keep bottom margin */
            max-width: 1280px; /* Set a max-width for better appearance on large screens */
            display: flex; 
            flex-wrap: wrap; 
            align-items: flex-end; 
            gap: 20px; 
        }
        .export-controls h3 { margin: 0; flex-basis: 100%; }
        .export-controls .form-group { display: flex; align-items: center; gap: 8px; }
        .export-controls .form-group label { font-size: 0.9em; font-weight: bold; margin-bottom: 0; }
        .export-controls select { width: 120px; }
        .export-controls input[type="color"] { width: 40px; height: 38px; padding: 2px; }
        .export-controls input[type="number"] { width: 50px; }
        .export-controls button { cursor: pointer; }
        .export-controls .bold-toggle, .export-controls .italic-toggle { width: 30px; height: 30px; font-weight: bold; }
        .export-controls .italic-toggle { font-style: italic; }
        .export-controls button.active { background-color: #3498db; color: white; border-color: #2980b9; }
        #export-pdf-button { margin-left: auto; padding: 10px 15px; font-size: 1em; }

        #preview-area { display: flex; flex-direction: column; gap: 20px; align-items: center; }
        .page {
            display: flex;
            width: 11in;
            height: 8.5in;
            background-color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border: 1px solid #333; /* Consistent outer border */
        }
        .panel {
            width: 50%;
            height: 100%;
            box-sizing: border-box;
            padding: 0.25in;
            overflow: visible; /* Allow controls to be seen */
        }
        #back-cover-panel, #inside-left-panel {
            border-right: 1px dashed #ccc; /* Consistent center fold line */
        }

        #back-cover-panel { 
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* Universal rule for vertical distribution */
        }
        #front-cover-panel {
            position: relative;
        }

        .book-panel {
            display: flex;
            flex-direction: column;
            height: 100%;
            justify-content: space-between;
        }
        
        #inside-right-panel {
            align-items: flex-end;
        }
        .list-item {
            position: relative;
            display: flex;
            gap: 0.1in;
            align-items: flex-start;
            height: 1.43in;
        }
        .custom-uploader {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 1.5in; /* Specific height for media blocks */
            width: 5in;   /* Specific width for media blocks */
            border: 2px dashed #ccc;
            border-radius: 5px;
            cursor: pointer;
        }
        #front-cover-uploader {
            width: 5in;
            height: 8in;
            border: 2px dashed #ccc;
            border-radius: 0;
            background-color: #EAEAEA;
            position: relative; /* Container for overlaid controls */
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .placeholder-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #333;
            text-align: center;
            font-size: 1.1rem;
            line-height: 1.4;
            pointer-events: none;
            width: 80%;
            z-index: 1; /* Ensure text is on top of the placeholder image */
        }
        #front-cover-uploader.has-image .placeholder-text {
            display: none;
        }
        #cover-generate-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none; /* Allow clicks to pass through the container */
        }
        #cover-title-input, #generate-cover-button {
             width: 100%;
             padding: 10px;
             box-sizing: border-box;
             pointer-events: auto; /* Make controls clickable */
        }
        
        .custom-uploader img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        #front-cover-uploader > img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
         .custom-uploader input[type="file"] { display: none; }


        .list-item.sortable-ghost { opacity: 0.4; background: #c8ebfb; }

        .list-item-controls {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            color: #888;
            right: 100%;
            margin-right: 5px;
            background-color: rgba(230, 230, 230, 0.85); /* Semi-opaque box */
            padding: 8px 5px; /* Add some padding */
            border-radius: 5px; /* Rounded corners */
        }
        
        .list-item-controls.controls-right {
            right: auto;
            left: 100%;
            margin-right: 0;
            margin-left: 5px;
        }

        .item-number { font-size: 1.2em; font-weight: bold; }
        .drag-handle { cursor: grab; font-size: 1.5em; line-height: 1; }
        .delete-button { background: none; border: none; cursor: pointer; color: #cc0000; font-weight: bold; font-size: 1.5em; line-height: 1; }

        .cover-uploader { width: 1.15in; height: 1.38in; flex-shrink: 0; cursor: pointer; position: relative; display: flex; align-items: center; justify-content: center; border: 1px dashed #ccc; }
        .cover-uploader img { max-width: 100%; max-height: 100%; object-fit: contain; display: block; }
        .cover-uploader.stretch img {
            object-fit: fill;
            width: 100%;
            height: 100%;
        }
        .cover-uploader input[type="file"] { display: none; }

        .list-item-details { flex-grow: 1; width: 3.75in; display: flex; flex-direction: column; }
        .editable-field {
            width: 100%;
            padding: 0;
            border: 1px solid #eee;
            background-color: transparent;
            line-height: 1.1;
            margin: 0;
        }
        .editable-field:focus { border-color: #999; outline: none; }

        .title-field { font-family: var(--title-font); color: var(--title-color); font-size: var(--title-font-size); font-weight: var(--title-font-weight); font-style: var(--title-font-style); }
        .author-field {
            font-family: var(--author-font); color: var(--author-color); font-size: var(--author-font-size); font-weight: var(--author-font-weight); font-style: var(--author-font-style);
            margin-top: 0.01in;
            margin-bottom: 0;
        }
        .description-field {
            font-family: var(--desc-font); color: var(--desc-color); font-size: var(--desc-font-size); font-weight: var(--desc-font-weight); font-style: var(--desc-font-style);
            margin-top: 0;
            height: 60px;
            resize: none;
            -webkit-hyphens: none; -ms-hyphens: none; hyphens: none;
            border: none;
            padding: 0;
            background-color: transparent;
        }
        .description-field:focus { border: 1px solid #999; outline: none; }


        /* --- PRINT STYLES --- */
        .print-mode .page {
            width: 11in;
            height: 8.5in;
            box-shadow: none;
            margin: 0;
            gap: 0;
            border: none !important; /* Remove outer border for PDF */
        }
        .print-mode .panel {
            padding: 0.25in;
            overflow: hidden; /* Hide controls for printing */
            border: none !important; /* Remove ALL borders for PDF */
        }

        .print-mode .custom-uploader,
        .print-mode .cover-uploader,
        .print-mode .editable-field {
            border: none !important; /* Remove ALL uploader and field borders for PDF */
        }
        .print-mode .list-item-controls,
        .print-mode #cover-generate-controls { /* Hide generate tools on PDF */
            display: none; 
        }
        .print-mode .book-panel {
             justify-content: space-between;
             gap: 0;
             height: 100%;
        }
        .print-mode #back-cover-panel {
             justify-content: space-between; /* Ensure layout is correct for print */
        }
        .print-mode #inside-left-panel {
            border-right: none;
        }
        .print-mode #inside-right-panel {
            align-items: flex-end;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
    <h1>Booklist Maker</h1>

    <div class="booklist-section">
        <h2>My Booklist Preview</h2>
        <div class="export-controls">
            <h3>Book Block Styles</h3>
            <div class="form-group" data-style-group="title">
                <label>Title</label>
                <select class="font-select">
                    <option value="'Georgia', serif">Georgia</option>
                    <option value="'Calibri', sans-serif">Calibri</option>
                    <option value="'Lato', sans-serif">Lato</option>
                    <option value="'Roboto', sans-serif">Roboto</option>
                    <option value="'Merriweather', serif">Merriweather</option>
                    <option value="'Garamond', serif">Garamond</option>
                    <option value="'Helvetica', sans-serif">Helvetica</option>
                    <option value="'Times New Roman', serif">Times New Roman</option>
                </select>
                <input class="font-size-input" type="number" value="19" min="8">
                <span>px</span>
                <input class="color-picker" type="color" value="#000000">
                <button class="bold-toggle">B</button>
                <button class="italic-toggle">I</button>
            </div>
            <div class="form-group" data-style-group="author">
                <label>Author/Call#</label>
                <select class="font-select">
                    <option value="'Calibri', sans-serif">Calibri</option>
                    <option value="'Georgia', serif">Georgia</option>
                    <option value="'Lato', sans-serif">Lato</option>
                    <option value="'Roboto', sans-serif">Roboto</option>
                    <option value="'Merriweather', serif">Merriweather</option>
                    <option value="'Garamond', serif">Garamond</option>
                    <option value="'Helvetica', sans-serif">Helvetica</option>
                    <option value="'Times New Roman', serif">Times New Roman</option>
                </select>
                <input class="font-size-input" type="number" value="16" min="8">
                <span>px</span>
                <input class="color-picker" type="color" value="#000000">
                <button class="bold-toggle active">B</button>
                <button class="italic-toggle">I</button>
            </div>
            <div class="form-group" data-style-group="desc">
                <label>Description</label>
                <select class="font-select">
                    <option value="'Calibri', sans-serif">Calibri</option>
                    <option value="'Georgia', serif">Georgia</option>
                    <option value="'Lato', sans-serif">Lato</option>
                    <option value="'Roboto', sans-serif">Roboto</option>
                    <option value="'Merriweather', serif">Merriweather</option>
                    <option value="'Garamond', serif">Garamond</option>
                    <option value="'Helvetica', sans-serif">Helvetica</option>
                    <option value="'Times New Roman', serif">Times New Roman</option>
                </select>
                <input class="font-size-input" type="number" value="13" min="8">
                <span>px</span>
                <input class="color-picker" type="color" value="#000000">
                <button class="bold-toggle">B</button>
                <button class="italic-toggle">I</button>
                <div style="display: flex; align-items: center; gap: 5px; margin-left: 20px;">
                    <input type="checkbox" id="stretch-block-covers-toggle">
                    <label for="stretch-block-covers-toggle" style="font-size:0.9em; font-weight:normal;">Stretch Book Block Covers</label>
                </div>
            </div>
            <h3 style="margin-top: 15px;">Back Cover Options</h3>
            <div class="form-group">
                <div style="display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" id="toggle-qr-code" checked>
                    <label for="toggle-qr-code" style="font-size:0.9em; font-weight:normal;">Show QR Code Block</label>
                </div>
                <div style="display: flex; align-items: center; gap: 5px; margin-left: 20px;">
                    <input type="checkbox" id="toggle-branding" checked>
                    <label for="toggle-branding" style="font-size:0.9em; font-weight:normal;">Show Branding Block</label>
                </div>
            </div>
            <h3 style="margin-top: 15px;">Cover Title Styles</h3>
            <div class="form-group" id="cover-title-style-group">
                <label>Cover Title</label>
                <select class="font-select">
                    <option value="'Oswald', sans-serif">Oswald</option>
                    <option value="'Anton', sans-serif">Anton</option>
                    <option value="'Lato', sans-serif">Lato</option>
                    <option value="'Roboto', sans-serif">Roboto</option>
                    <option value="'Georgia', serif">Georgia</option>
                    <option value="'Merriweather', serif">Merriweather</option>
                    <option value="'Garamond', serif">Garamond</option>
                    <option value="'Helvetica', sans-serif">Helvetica</option>
                </select>
                <input class="font-size-input" type="number" value="40" min="8">
                <span>px</span>
                <input class="color-picker" type="color" value="#FFFFFF">
                <button class="bold-toggle active">B</button>
                <button class="italic-toggle">I</button>
                <label style="margin-left: 10px;">BG:</label>
                <input class="color-picker" id="cover-title-bg-color" type="color" value="#000000">
                 <div style="display: flex; align-items: center; gap: 5px; margin-left:15px;">
                    <input type="checkbox" id="stretch-covers-toggle" checked>
                    <label for="stretch-covers-toggle" style="font-size:0.9em; font-weight:normal;">Stretch Covers to Fit</label>
                </div>
            </div>
            <button id="export-pdf-button">Generate PDF</button>
        </div>

        <div id="preview-area">
            <div class="page" id="print-page-1">
                <div class="panel" id="back-cover-panel">
                    <!-- Book items will be dynamically inserted here before the uploaders -->
                    <label id="qr-code-uploader" class="custom-uploader">
                        <img src="https://placehold.co/480x144/EAEAEA/333333?text=Upload+QR+Code+%26+Promo+Image" alt="QR Code and Promo Placeholder">
                        <input type="file" accept="image/*">
                    </label>
                    <label id="branding-uploader" class="custom-uploader">
                        <img src="https://placehold.co/480x144/EAEAEA/333333?text=Upload+Library+Branding+Image" alt="Library Branding Placeholder">
                        <input type="file" accept="image/*">
                    </label>
                </div>
                <div class="panel" id="front-cover-panel">
                    <div id="front-cover-uploader" class="custom-uploader">
                        <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="Cover Image Placeholder">
                        <div class="placeholder-text">
                            Upload a Custom Cover<br>(5x8 inches)<br><br>OR<br><br>Use the Auto-Generator Below<br>(This will use the first 12 covers from your list to create a collage)
                        </div>
                        <div id="cover-generate-controls">
                            <input type="text" id="cover-title-input" placeholder="Enter Cover Title...">
                            <button id="generate-cover-button">Auto-Generate Cover</button>
                        </div>
                        <input type="file" accept="image/*">
                    </div>
                </div>
            </div>
            <div class="page" id="print-page-2">
                <div class="panel book-panel" id="inside-left-panel"></div>
                <div class="panel book-panel" id="inside-right-panel"></div>
            </div>
        </div>
    </div>

    <hr>

    <div class="search-form">
        <div class="form-field">
            <label for="keywordInput">Keyword (any field)</label>
            <input type="text" id="keywordInput" placeholder="e.g., The Hobbit">
        </div>
        <div class="form-field">
            <label for="titleInput">Title</label>
            <input type="text" id="titleInput" placeholder="e.g., Dune">
        </div>
        <div class="form-field">
            <label for="authorInput">Author</label>
            <input type="text" id="authorInput" placeholder="e.g., Frank Herbert">
        </div>
        <div class="form-field">
            <label for="subjectInput">Subject</label>
            <input type="text" id="subjectInput" placeholder="e.g., science fiction">
        </div>
        <div class="form-field">
            <label for="languageInput">Language</label>
            <input type="text" id="languageInput" placeholder="e.g., spa (for Spanish)">
        </div>
    </div>
    <button id="fetchButton">Search</button>

    <hr>

    <h2>Search Results</h2>
    <div id="results-container"></div>

    <script>
        // Get all element references
        const keywordInput = document.getElementById('keywordInput');
        const titleInput = document.getElementById('titleInput');
        const authorInput = document.getElementById('authorInput');
        const subjectInput = document.getElementById('subjectInput');
        const languageInput = document.getElementById('languageInput');
        const fetchButton = document.getElementById('fetchButton');
        const resultsContainer = document.getElementById('results-container');
        const exportPdfButton = document.getElementById('export-pdf-button');
        const backCoverPanel = document.getElementById('back-cover-panel');
        const insideLeftPanel = document.getElementById('inside-left-panel');
        const insideRightPanel = document.getElementById('inside-right-panel');
        const previewArea = document.getElementById('preview-area');
        const qrCodeUploader = document.getElementById('qr-code-uploader');
        const brandingUploader = document.getElementById('branding-uploader');
        const frontCoverUploader = document.getElementById('front-cover-uploader');
        const generateCoverButton = document.getElementById('generate-cover-button');
        const coverTitleInput = document.getElementById('cover-title-input');
        const stretchCoversToggle = document.getElementById('stretch-covers-toggle');
        const stretchBlockCoversToggle = document.getElementById('stretch-block-covers-toggle');
        const toggleQrCode = document.getElementById('toggle-qr-code');
        const toggleBranding = document.getElementById('toggle-branding');


        let myBooklist = [];
        const MAX_BOOKS = 15;

        function createBlankBook() {
            return {
                key: `blank-${crypto.randomUUID()}`,
                isBlank: true,
                title: '[Enter Title]',
                author: '[Enter Author]',
                callNumber: '[Call #]',
                description: '[Enter a brief description here...]',
                cover_i: null,
                customCoverData: 'https://placehold.co/110x132/EAEAEA/333333?text=Upload%20Cover'
            };
        }

        function initializeBooklist() {
            for (let i = 0; i < MAX_BOOKS; i++) {
                myBooklist.push(createBlankBook());
            }
            renderBooklist();
        }

        // --- EVENT LISTENERS ---
        fetchButton.addEventListener('click', () => getBooks());
        generateCoverButton.addEventListener('click', generateCoverCollage);
        stretchCoversToggle.addEventListener('change', generateCoverCollage);
        stretchBlockCoversToggle.addEventListener('change', applyBlockCoverStyle);
        toggleQrCode.addEventListener('change', updateBackCoverLayout);
        toggleBranding.addEventListener('change', updateBackCoverLayout);

        function setupFileChangeHandler(uploaderElement) {
            const fileInput = uploaderElement.querySelector('input[type="file"]');
            const imgElement = uploaderElement.querySelector('img');

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        imgElement.src = event.target.result;
                        imgElement.dataset.isPlaceholder = "false";
                        // Add class to hide the placeholder text
                        uploaderElement.classList.add('has-image');
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
        
        // Apply the simple file-change logic to all three static uploaders.
        setupFileChangeHandler(qrCodeUploader);
        setupFileChangeHandler(brandingUploader);
        setupFileChangeHandler(frontCoverUploader);

        // Add a special click handler ONLY for the complex front cover uploader.
        // Because the container is now a DIV, it has no default behavior, so we
        // can explicitly control what happens on click.
        const coverControls = document.getElementById('cover-generate-controls');
        frontCoverUploader.addEventListener('click', (e) => {
            // If the user clicked inside the controls, let the browser handle
            // the text input or button click as usual. Do nothing else.
            if (coverControls.contains(e.target)) {
                return;
            }

            // Otherwise, if the user clicked anywhere else on the component,
            // we manually trigger the file selection dialog.
            const fileInput = frontCoverUploader.querySelector('input[type="file"]');
            fileInput.click();
        });


        function applyStyles() {
            document.querySelectorAll('.export-controls .form-group[data-style-group]').forEach(group => {
                const styleGroup = group.dataset.styleGroup;
                const font = group.querySelector('.font-select').value;
                const size = group.querySelector('.font-size-input').value + 'px';
                const color = group.querySelector('.color-picker').value;
                const isBold = group.querySelector('.bold-toggle').classList.contains('active');
                const isItalic = group.querySelector('.italic-toggle').classList.contains('active');

                previewArea.style.setProperty(`--${styleGroup}-font`, font);
                previewArea.style.setProperty(`--${styleGroup}-font-size`, size);
                previewArea.style.setProperty(`--${styleGroup}-color`, color);
                previewArea.style.setProperty(`--${styleGroup}-font-weight`, isBold ? 'bold' : 'normal');
                previewArea.style.setProperty(`--${styleGroup}-font-style`, isItalic ? 'italic' : 'normal');
            });
        }

        function applyBlockCoverStyle() {
            const shouldStretch = stretchBlockCoversToggle.checked;
            document.querySelectorAll('#preview-area .cover-uploader').forEach(uploader => {
                if (shouldStretch) {
                    uploader.classList.add('stretch');
                } else {
                    uploader.classList.remove('stretch');
                }
            });
        }

        document.querySelectorAll('.export-controls .form-group[data-style-group], #cover-title-style-group').forEach(group => {
            group.querySelectorAll('select, input').forEach(input => {
                 input.addEventListener('change', applyStyles);
                 input.addEventListener('input', applyStyles);
            });
            group.querySelectorAll('button').forEach(button => {
                button.addEventListener('click', (e) => {
                    if(e.target.classList.contains('bold-toggle') || e.target.classList.contains('italic-toggle')){
                        e.target.classList.toggle('active');
                    }
                    applyStyles();
                });
            });
        });

        // --- SEARCH AND ADD-TO-LIST LOGIC ---
        function getBooks() {
            resultsContainer.innerHTML = '<p>Searching...</p>';
            const queryParams = [];
            if (keywordInput.value) queryParams.push(`q=${encodeURIComponent(keywordInput.value)}`);
            if (titleInput.value) queryParams.push(`title=${encodeURIComponent(titleInput.value)}`);
            if (authorInput.value) queryParams.push(`author=${encodeURIComponent(authorInput.value)}`);
            if (subjectInput.value) queryParams.push(`subject=${encodeURIComponent(subjectInput.value)}`);
            if (languageInput.value) queryParams.push(`language=${encodeURIComponent(languageInput.value)}`);
            
            if (queryParams.length === 0) {
                resultsContainer.innerHTML = '<p>Please enter at least one search term.</p>';
                return;
            }
            const queryString = queryParams.join('&');
            const apiUrl = `https://openlibrary.org/search.json?${queryString}`;
            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    resultsContainer.innerHTML = '';
                    const books = data.docs;
                    if (books.length === 0) { resultsContainer.innerHTML = '<p>No results found.</p>'; return; }
                    books.forEach(book => {
                        if (book.cover_i) {
                            const bookElement = document.createElement('div');
                            const coverElement = document.createElement('img');
                            coverElement.src = `https://covers.openlibrary.org/b/id/${book.cover_i}-M.jpg`;
                            const titleElement = document.createElement('p');
                            titleElement.textContent = book.title;
                            const addButton = document.createElement('button');
                            
                            const isAlreadyAdded = myBooklist.some(item => item.key === book.key);
                            if(isAlreadyAdded){
                                addButton.innerHTML = '&#10003;';
                                addButton.classList.add('added');
                            } else {
                                addButton.textContent = 'Add to List';
                            }

                            addButton.addEventListener('click', () => {
                                const isAdded = myBooklist.some(item => item.key === book.key);
                                const firstBlankIndex = myBooklist.findIndex(item => item.isBlank);

                                if (!isAdded) { // If it's NOT in the list, try to ADD it
                                    if (firstBlankIndex !== -1) {
                                        myBooklist[firstBlankIndex] = {
                                            key: book.key,
                                            isBlank: false,
                                            title: book.title,
                                            author: book.author_name ? book.author_name.join(', ') : '',
                                            callNumber: '[Call #]',
                                            description: '[Enter a brief description here...]',
                                            cover_i: book.cover_i,
                                        };
                                        addButton.innerHTML = '&#10003;';
                                        addButton.classList.add('added');
                                    } else {
                                        alert(`All ${MAX_BOOKS} book slots are full. Please delete one before adding another.`);
                                    }
                                } else { // If it IS in the list, REMOVE it
                                    const indexToRemove = myBooklist.findIndex(item => item.key === book.key);
                                    if (indexToRemove !== -1) {
                                        myBooklist[indexToRemove] = createBlankBook();
                                    }
                                    addButton.textContent = 'Add to List';
                                    addButton.classList.remove('added');
                                }
                                renderBooklist();
                            });
                            bookElement.appendChild(coverElement);
                            bookElement.appendChild(titleElement);
                            bookElement.appendChild(addButton);
                            resultsContainer.appendChild(bookElement);
                        }
                    });
                })
                .catch(error => console.error('There was a problem:', error));
        }


        // --- LIVE PREVIEW RENDER LOGIC ---
        function renderBooklist() {
            insideLeftPanel.innerHTML = '';
            insideRightPanel.innerHTML = '';
            
            // Clear only the book items from the back cover panel before re-rendering
            backCoverPanel.querySelectorAll('.list-item').forEach(item => item.remove());

            myBooklist.forEach((bookItem, index) => {
                let targetPanel;
                let insertBeforeElement = null;

                if (index < 5) {
                    targetPanel = insideLeftPanel;
                } else if (index < 10) {
                    targetPanel = insideRightPanel;
                } else {
                    targetPanel = backCoverPanel;
                    insertBeforeElement = qrCodeUploader; // Insert books before the QR code uploader
                }

                const listItem = document.createElement('div');
                listItem.className = 'list-item';
                listItem.dataset.id = bookItem.key;
                listItem.dataset.isBlank = bookItem.isBlank;

                const controlsDiv = document.createElement('div');
                controlsDiv.className = 'list-item-controls';
                
                if (targetPanel === insideRightPanel) {
                    controlsDiv.classList.add('controls-right');
                }

                const itemNumber = document.createElement('span');
                itemNumber.className = 'item-number';
                itemNumber.textContent = index + 1;
                const dragHandle = document.createElement('div');
                dragHandle.className = 'drag-handle';
                dragHandle.innerHTML = '&#9776;';
                const deleteButton = document.createElement('button');
                deleteButton.className = 'delete-button';
                deleteButton.innerHTML = '&times;';
                deleteButton.onclick = () => {
                    const originalKey = myBooklist[index].key;
                    myBooklist[index] = createBlankBook(); // Replace with a new blank book
                    renderBooklist();
                    const searchButton = document.querySelector(`#results-container button[data-book-key="${originalKey}"]`);
                    if(searchButton) {
                        searchButton.textContent = 'Add to List';
                        searchButton.classList.remove('added');
                    }
                };
                
                controlsDiv.appendChild(dragHandle);
                controlsDiv.appendChild(itemNumber);
                controlsDiv.appendChild(deleteButton);

                const coverUploader = document.createElement('label');
                coverUploader.className = 'cover-uploader';
                const coverImg = document.createElement('img');
                coverImg.crossOrigin = 'Anonymous';
                coverImg.src = bookItem.customCoverData || (bookItem.cover_i ? `https://covers.openlibrary.org/b/id/${bookItem.cover_i}-M.jpg` : 'https://placehold.co/110x132/EAEAEA/333333?text=Upload%20Cover');
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = 'image/*';
                fileInput.onchange = (e) => {
                     const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            myBooklist.find(b => b.key === bookItem.key).customCoverData = event.target.result;
                            coverImg.src = event.target.result;
                        };
                        reader.readAsDataURL(file);
                    }
                };
                coverUploader.appendChild(coverImg);
                coverUploader.appendChild(fileInput);
                
                const detailsDiv = document.createElement('div');
                detailsDiv.className = 'list-item-details';

                const titleField = document.createElement('div');
                titleField.className = 'editable-field title-field';
                titleField.contentEditable = true;
                titleField.textContent = bookItem.title;
                titleField.oninput = (e) => { 
                    bookItem.title = e.target.textContent;
                    if(bookItem.isBlank && bookItem.title !== '[Enter Title]') {
                        bookItem.isBlank = false;
                        listItem.dataset.isBlank = false;
                    }
                };

                const authorField = document.createElement('div');
                authorField.className = 'editable-field author-field';
                authorField.contentEditable = true;
                authorField.textContent = bookItem.author.startsWith('[Enter') ? `${bookItem.author} - ${bookItem.callNumber}` : `By ${bookItem.author} - ${bookItem.callNumber}`;
                authorField.oninput = (e) => { 
                    let text = e.target.textContent;
                    if (text.includes('By ') && text.includes(' - ')) {
                        const parts = text.replace('By ', '').split(' - ');
                        bookItem.author = parts[0] || '';
                        bookItem.callNumber = parts[1] || '';
                    } else {
                        const parts = text.split(' - ');
                        bookItem.author = parts[0] || '';
                        bookItem.callNumber = parts[1] || '';
                    }
                 };

                const descriptionField = document.createElement('div');
                descriptionField.className = 'editable-field description-field';
                descriptionField.contentEditable = true;
                descriptionField.textContent = bookItem.description;
                descriptionField.oninput = (e) => { bookItem.description = e.target.textContent; };
                
                detailsDiv.appendChild(titleField);
                detailsDiv.appendChild(authorField);
                detailsDiv.appendChild(descriptionField);

                const placeholders = {
                    title: '[Enter Title]',
                    author: '[Enter Author] - [Call #]',
                    description: '[Enter a brief description here...]'
                };

                const setupPlaceholder = (element, placeholderText, originalColor) => {
                    if (element.textContent === placeholderText) {
                        element.style.color = '#757575';
                    }
                    element.onfocus = () => {
                        if (element.textContent === placeholderText) {
                            element.textContent = '';
                            element.style.color = originalColor;
                        }
                    };
                    element.onblur = () => {
                        if (element.textContent.trim() === '') {
                            element.textContent = placeholderText;
                            element.style.color = '#757575';
                        }
                    };
                };

                setupPlaceholder(titleField, placeholders.title, getComputedStyle(titleField).color);
                setupPlaceholder(authorField, placeholders.author, getComputedStyle(authorField).color);
                setupPlaceholder(descriptionField, placeholders.description, getComputedStyle(descriptionField).color);
                
                listItem.appendChild(controlsDiv);
                listItem.appendChild(coverUploader);
                listItem.appendChild(detailsDiv);
                
                if (insertBeforeElement) {
                    targetPanel.insertBefore(listItem, insertBeforeElement);
                } else {
                    targetPanel.appendChild(listItem);
                }
            });
            applyStyles();
            applyBlockCoverStyle();
            updateBackCoverLayout(); // Set initial layout
        }

        function updateBackCoverLayout() {
            const showQr = toggleQrCode.checked;
            const showBranding = toggleBranding.checked;

            qrCodeUploader.style.display = showQr ? 'flex' : 'none';
            brandingUploader.style.display = showBranding ? 'flex' : 'none';

            let extraSlotsToShow = 0;
            if (!showQr) extraSlotsToShow++;
            if (!showBranding) extraSlotsToShow++;

            const backCoverBooks = backCoverPanel.querySelectorAll('.list-item');
            backCoverBooks.forEach((item, index) => {
                // The first 3 slots are always for books 11, 12, 13
                // The next 2 slots are for books 14, 15
                if (index < 3 + extraSlotsToShow) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // --- DRAG-AND-DROP INITIALIZATION ---
        const sortableOptions = {
            group: 'shared-list',
            handle: '.drag-handle',
            animation: 150,
            ghostClass: 'sortable-ghost',
            onEnd: function () {
                const newBooklist = [];
                const allPanelItems = [
                    ...Array.from(insideLeftPanel.children),
                    ...Array.from(insideRightPanel.children),
                    // For the back cover, only grab the list items, not the uploaders
                    ...Array.from(backCoverPanel.querySelectorAll('.list-item'))
                ];

                const allIds = allPanelItems.map(item => item.dataset.id).filter(id => id);

                allIds.forEach(id => newBooklist.push(myBooklist.find(b => b.key === id)));
                
                // Add back any books that might have been hidden on the back panel
                const currentIds = new Set(newBooklist.map(b => b.key));
                const allBookIds = new Set(myBooklist.map(b => b.key));
                allBookIds.forEach(id => {
                    if (!currentIds.has(id)) {
                        newBooklist.push(myBooklist.find(b => b.key === id));
                    }
                });

                myBooklist = newBooklist;
                renderBooklist();
            },
        };
        new Sortable(insideLeftPanel, sortableOptions);
        new Sortable(insideRightPanel, sortableOptions);
        new Sortable(backCoverPanel, sortableOptions);

        // --- COVER COLLAGE GENERATION ---
        function generateCoverCollage() {
            const button = generateCoverButton;
            button.textContent = 'Generating...';
            button.disabled = true;

            const shouldStretchCovers = stretchCoversToggle.checked; // Read the checkbox state immediately

            const booksWithCovers = myBooklist.filter(book => !book.isBlank && (book.cover_i || (book.customCoverData && !book.customCoverData.includes('placehold.co'))));
            
            if (booksWithCovers.length < 12) {
                alert('Please add at least 12 books with covers to generate a collage.');
                button.textContent = 'Auto-Generate Cover';
                button.disabled = false;
                return;
            }

            const coversToDraw = booksWithCovers.slice(0, 12);
            const canvas = document.createElement('canvas');
            const dpi = 150; 
            canvas.width = 5 * dpi;
            canvas.height = 8 * dpi;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, canvas.width, canvas.height);


            const loadImage = (src) => {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.crossOrigin = 'Anonymous';
                    img.onload = () => resolve(img);
                    img.onerror = reject;
                    img.src = src;
                });
            };

            const imagePromises = coversToDraw.map(book => {
                const src = book.customCoverData || `https://covers.openlibrary.org/b/id/${book.cover_i}-L.jpg`; // Use Large covers
                return loadImage(src);
            });
            
            const wrapText = (text, maxWidth) => {
                const words = text.split(' ');
                let lines = [];
                let currentLine = words[0] || '';

                for (let i = 1; i < words.length; i++) {
                    const word = words[i];
                    const width = ctx.measureText(currentLine + " " + word).width;
                    if (width < maxWidth) {
                        currentLine += " " + word;
                    } else {
                        lines.push(currentLine);
                        currentLine = word;
                    }
                }
                lines.push(currentLine);
                return lines;
            }

            const titleStyleGroup = document.getElementById('cover-title-style-group');
            const font = titleStyleGroup.querySelector('.font-select').value;
            const isBold = titleStyleGroup.querySelector('.bold-toggle').classList.contains('active');
            const isItalic = titleStyleGroup.querySelector('.italic-toggle').classList.contains('active');
            let fontStyle = '';
            if (isItalic) fontStyle += 'italic ';
            if (isBold) fontStyle += 'bold ';
            const fontToLoad = `${fontStyle} 10px ${font}`;

            document.fonts.load(fontToLoad).then(() => {
                Promise.all(imagePromises).then(images => {
                    // --- 1. Define Layout Constants & Ratios ---
                    const bookAspectRatio = 0.75; // Width / Height for book covers
                    const canvasWidthPx = canvas.width;
                    const canvasHeightPx = canvas.height;
                    const titleMarginPx = 0.2 * dpi;
                    const topPadding = 0; // Set to 0 to make the top row flush
                    const vGutterToHeightRatio = 0.15; // Vertical gutter size as a percentage of book cover height

                    // --- 2. Calculate Title Block Height (as it is a fixed constraint) ---
                    const fontSizePt = parseInt(titleStyleGroup.querySelector('.font-size-input').value, 10);
                    const fontSizePx = fontSizePt * (dpi / 72);
                    const coverTitle = coverTitleInput.value || "My Booklist";
                    ctx.font = `${fontStyle} ${fontSizePx}px ${font}`;
                    const lines = wrapText(coverTitle, canvasWidthPx - (2 * titleMarginPx));
                    const lineHeight = fontSizePx * 1.2;
                    const bgPaddingVPx = 0.2 * dpi;
                    const totalTitleBlockHeightPx = (lines.length * lineHeight) + (2 * bgPaddingVPx);

                    // --- 3. Calculate the available vertical space for book rows & their internal gutters ---
                    const totalFixedVerticalSpace = topPadding + titleMarginPx + totalTitleBlockHeightPx + titleMarginPx;
                    const availableHeightForBooksAndGutters = canvasHeightPx - totalFixedVerticalSpace;

                    // --- 4. Solve for the exact book slot height that will make everything fit ---
                    // The total height is (4 rows of books) + (2 internal gutters between the bottom 3 rows)
                    const slotHeight = availableHeightForBooksAndGutters / (4 + 2 * vGutterToHeightRatio);
                    
                    // --- 5. Derive all other dimensions from the calculated slot height ---
                    const slotWidth = slotHeight * bookAspectRatio;
                    const vGutter = slotHeight * vGutterToHeightRatio;
                    // Horizontal gutter is now calculated to perfectly space the books across the width
                    const hGutter = (canvasWidthPx - (3 * slotWidth)) / 4;
                    
                    const startY = topPadding;

                    // --- 6. Draw Book Covers ---
                    let imageIndex = 0;
                    
                    const drawImage = (img, x, y, w, h) => {
                        if (shouldStretchCovers) {
                            ctx.drawImage(img, x, y, w, h);
                        } else {
                            const imgAspectRatio = img.width / img.height;
                            const slotAspectRatio = w / h;
                            let dw, dh, dx, dy;
                            if (imgAspectRatio > slotAspectRatio) {
                                dw = w;
                                dh = dw / imgAspectRatio;
                                dx = x;
                                dy = y + (h - dh) / 2;
                            } else {
                                dh = h;
                                dw = dh * imgAspectRatio;
                                dx = x + (w - dw) / 2;
                                dy = y;
                            }
                            ctx.drawImage(img, dx, dy, dw, dh);
                        }
                    };

                    // Draw Top Row (3 books)
                    const topRowY = startY;
                    for (let col = 0; col < 3; col++) {
                        const slotX = hGutter + col * (slotWidth + hGutter);
                        drawImage(images[imageIndex], slotX, topRowY, slotWidth, slotHeight);
                        imageIndex++;
                    }

                    // Draw Bottom Grid (9 books)
                    const gridTopY = topRowY + slotHeight + titleMarginPx + totalTitleBlockHeightPx + titleMarginPx;
                    for (let row = 0; row < 3; row++) {
                        const currentRowY = gridTopY + row * (slotHeight + vGutter);
                        for (let col = 0; col < 3; col++) {
                            const slotX = hGutter + col * (slotWidth + hGutter);
                            drawImage(images[imageIndex], slotX, currentRowY, slotWidth, slotHeight);
                            imageIndex++;
                        }
                    }

                    // --- 7. Draw Title Overlay ---
                    const color = titleStyleGroup.querySelector('.color-picker').value;
                    const bgColor = document.getElementById('cover-title-bg-color').value;
                    const titleBoxY = topRowY + slotHeight + titleMarginPx;
                    
                    ctx.fillStyle = bgColor;
                    ctx.fillRect(0, titleBoxY, canvasWidthPx, totalTitleBlockHeightPx);

                    ctx.fillStyle = color;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    
                    const textBlockHeight = lines.length * lineHeight;
                    // Center the text block vertically within the title background
                    let firstLineY = titleBoxY + (totalTitleBlockHeightPx / 2) - (textBlockHeight / 2) + (lineHeight / 2);
                    
                    lines.forEach((line, index) => {
                        ctx.fillText(line.trim(), canvasWidthPx / 2, firstLineY + (index * lineHeight));
                    });


                    const dataUrl = canvas.toDataURL('image/png');
                    const frontCoverImg = frontCoverUploader.querySelector('img');
                    frontCoverImg.src = dataUrl;
                    frontCoverImg.dataset.isPlaceholder = "false";
                    frontCoverUploader.classList.add('has-image');

                }).catch(error => {
                    console.error('Error loading cover images for collage:', error);
                    alert('Could not load all cover images. Please try again.');
                }).finally(() => {
                    button.textContent = 'Auto-Generate Cover';
                    button.disabled = false;
                });
            }).catch(err => {
                console.error('Font could not be loaded for canvas:', err);
                alert('The selected title font could not be loaded for the canvas. Please try a system font like Georgia or Helvetica.');
                button.textContent = 'Auto-Generate Cover';
                button.disabled = false;
            });
        }


        // --- FINAL PDF EXPORT ---
        exportPdfButton.addEventListener('click', () => {
            exportPdfButton.textContent = 'Generating...';
            exportPdfButton.disabled = true;

            // Hide blank elements before generating PDF
            const elementsToRestore = [];
            document.querySelectorAll('.list-item').forEach(item => {
                if (item.dataset.isBlank === 'true') {
                    elementsToRestore.push({el: item, display: item.style.display});
                    item.style.display = 'none';
                }
            });

            document.querySelectorAll('.custom-uploader').forEach(uploader => {
                const img = uploader.querySelector('img');
                if (img && img.src.includes('placehold.co')) {
                     elementsToRestore.push({el: uploader, display: uploader.style.display});
                    uploader.style.display = 'none';
                }
            });


            previewArea.classList.add('print-mode');
            
            const page1 = document.getElementById('print-page-1');
            const page2 = document.getElementById('print-page-2');
            
            setTimeout(() => {
                document.fonts.ready.then(() => {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({ orientation: 'landscape', unit: 'in', format: 'letter' });

                    const options = { scale: 3, useCORS: true };

                    html2canvas(page1, options)
                        .then(canvas1 => {
                            const imgData1 = canvas1.toDataURL('image/png');
                            pdf.addImage(imgData1, 'PNG', 0, 0, 11, 8.5);
                            pdf.addPage();
                            return html2canvas(page2, options);
                        })
                        .then(canvas2 => {
                            const imgData2 = canvas2.toDataURL('image/png');
                            pdf.addImage(imgData2, 'PNG', 0, 0, 11, 8.5);
                            pdf.save('bifold-booklist.pdf');
                        })
                        .catch(err => {
                            console.error("PDF Generation failed:", err);
                            alert("An error occurred generating the PDF. Please check the console for details.");
                        })
                        .finally(() => {
                            previewArea.classList.remove('print-mode');
                             // Restore blank elements
                            elementsToRestore.forEach(item => item.el.style.display = item.display || '');
                            exportPdfButton.textContent = 'Generate PDF';
                            exportPdfButton.disabled = false;
                        });
                });
            }, 100);
        });

        // Initialize the app
        initializeBooklist();
        applyStyles();
    </script>
</body>
</html>

